<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | ุฅุฏุงุฑุฉ ุงูุณุฌูุงุช</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>

<body>
    <div class="container animate-fade-in">
        <!-- Persistent Nav -->
        <nav class="app-nav">
            <div class="nav-content">
                <div style="font-weight: 900; font-size: 1.5rem; letter-spacing: -1px;">
                    <span style="color: var(--primary);">DEEP</span> AI
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
                    <li><a href="teacher-qr-scanner.html">ุงููุงุณุญ</a></li>
                    <li><a href="attendance-management.html" class="active">ุงูุฅุฏุงุฑุฉ</a></li>
                    <li><a href="attendance-report.html">ุงูุชูุงุฑูุฑ</a></li>
                </ul>
            </div>
        </nav>

        <header class="header-section no-print">
            <h1 class="header-title">ูุฑูุฒ ุงูุชุญูู ูุงูุจูุงูุงุช</h1>
            <p class="header-subtitle">ุฅุฏุงุฑุฉ ุงูุญุถูุฑ ูุงููุฒุงููุฉ ุงูุณุญุงุจูุฉ ููุทูุงุจ</p>
        </header>

        <!-- Dynamic Stats -->
        <div class="stats-grid no-print">
            <div class="glass-card stat-card">
                <span class="stat-label">ุฅุฌูุงูู ุงูุทูุงุจ</span>
                <span id="stat-total-students" class="stat-value">--</span>
                <div class="badge badge-success">ูุญุฏุซ ูุญุธูุงู</div>
            </div>
            <div class="glass-card stat-card">
                <span class="stat-label">ุณุฌูุงุช ุงูููู</span>
                <span id="stat-today-scans" class="stat-value">0</span>
                <div class="badge badge-success">ูุดุท</div>
            </div>
            <div class="glass-card stat-card" style="border-right: 4px solid var(--accent);">
                <span class="stat-label">ุทูุงุจ ูู ุฎุทุฑ (ุบูุงุจ ูุชูุฑุฑ)</span>
                <span id="stat-at-risk" class="stat-value">--</span>
                <div class="badge badge-danger">ูุชุทูุจ ูุชุงุจุนุฉ</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="glass-card no-print" style="padding: 2rem; margin-bottom: 2rem;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ ุงูุณุฌู</button>
                    <button class="btn btn-secondary" onclick="exportData()">๐พ ุชุตุฏูุฑ Excel</button>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <!-- The Sync Component (Deep Enhancement Feature) -->
                    <button class="btn btn-secondary" onclick="syncStudentsToCloud()"
                        title="ูุฒุงููุฉ ุงููุงุฆูุฉ ุงููุญููุฉ ูุน ุงูุณุญุงุจุฉ">
                        โ๏ธ ูุฒุงููุฉ ูุงุนุฏุฉ ุงูุทูุงุจ
                    </button>
                </div>
            </div>
        </div>

        <div class="glass-card" style="padding: 2rem;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ุงูุทุงูุจ</th>
                            <th>ุงููุงุฏุฉ</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูููุช</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th class="no-print">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-body">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- HOD PIN Modal - Kept for security -->
        <div id="hodModal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(2,6,23,0.95); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(20px);">
            <div class="glass-card" style="width:100%; max-width:400px; padding:3rem; text-align:center;">
                <h2 style="margin-bottom: 1rem;">๐ ุฏุฎูู ุงููุตุงุฏูุฉ</h2>
                <p style="color:var(--text-muted); margin-bottom: 2rem;">ูุฑุฌู ุฅุฏุฎุงู ุฑูุฒ HOD ูููุตูู</p>
                <input type="password" id="hodPin" class="form-control"
                    style="text-align:center; font-size:2rem; letter-spacing:0.5rem; margin-bottom:1.5rem;" autofocus>
                <button class="btn btn-primary" style="width:100%;" onclick="verifyPin()">ูุชุญ ุงููุธุงู</button>
            </div>
        </div>
    </div>

    <script>
        // Central Student Database (to be moved to Firebase)
        // Central Student Database (Fallback)
        const localStudents = [
            "ููุณู ููุซุงู ุทุงูุจ ุนุฌูู", "ุญุณูู ุนูู ุฏูุดุงู ูุงุธู", "ููุฑุงูุญุณู ุจุงุณู ุนุจุฏุงูุฑุฒุงู ุญุณูู",
            "ูุตุทูู ูุคุงุฏ ูุงุถู ุนุจุฏ ุงูุงููุฑ", "ุนูู ุฌูุงู ุฎูู ูุนูู", "ูุตุทูู ูุญูุฏ ูุฑุฏุงู ุญุณู",
            "ุถุญู ุญูุฏุฑ ููุงู ุฌูุฏู", "ุนูู ูุญูุฏ ุฌุจุงุฑ ุญุณูู", "ุจููู ุฏูุงุฑ ุฑุญูู ุตูุฑ",
            "ุฒูุฑุงุก ูุญูุฏ ุณุฑูุญ ุนุจุฏ ุงูุญุณู", "ุฒูุฑุงุก ุงุจุฑุงููู ููุฏู ุฎุถูุฑ", "ููุชุธุฑ ุญููุฏ ุนุฐุงุจ ุถุงุญู",
            "ูุจุฃ ุฌุงุณู ุฑุญูู ุดุงูุน", "ูุนุตููุฉ ุนุจุฏ ุงูุญุณูู ุฌุจุงุฑ ุนุจุฏุงููู", "ุฏุงููุง ูุฑูู ูููู ููุตูุฑ",
            "ูุคูู ุณุนุฏูู ุฌุจุงุฑ ููุชู", "ุณุจุฃ ูุญูุฏ ุตุจุฑู ุณูุทุงู", "ุฑููู ุงุซูุฑ ุงุญูุฏ ูุทูู", "ูุงุธู ูุญูุฏ ุฌุงุณู"
        ];

        // Firebase Setup
        const firebaseConfig = {
            apiKey: "AIzaSyDLSX6DY_79BD8ZEYBRYh_jtmP0mHslzkE",
            authDomain: "ai-attendance-husam.firebaseapp.com",
            databaseURL: "https://ai-attendance-husam-default-rtdb.firebaseio.com",
            projectId: "ai-attendance-husam",
            storageBucket: "ai-attendance-husam.firebasestorage.app",
            messagingSenderId: "305903941972",
            appId: "1:305903941972:web:d914431aab5a1cc6b5b0c1",
            measurementId: "G-EJEKCTT2M9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        let currentStudentList = [];

        // 1. PIN Security
        function checkAuth() {
            if (sessionStorage.getItem('hod_auth') !== 'true') {
                document.getElementById('hodModal').style.display = 'flex';
            } else {
                initDashboard();
            }
        }

        function verifyPin() {
            const pin = document.getElementById('hodPin').value;
            if (pin === '987987987') {
                sessionStorage.setItem('hod_auth', 'true');
                document.getElementById('hodModal').style.display = 'none';
                initDashboard();
            } else {
                alert('ุฑูุฒ ุฎุงุทุฆ');
            }
        }

        // 2. Dashboard Logic
        async function initDashboard() {
            await fetchStudents();
            loadAttendance();
            updateStats();
        }

        async function fetchStudents() {
            try {
                const snap = await db.ref('students_list').once('value');
                if (snap.exists() && Array.isArray(snap.val())) {
                    currentStudentList = snap.val();
                } else {
                    currentStudentList = localStudents;
                }
                updateStats();
            } catch (e) {
                console.error("Fetch error:", e);
                currentStudentList = localStudents;
                updateStats();
            }
        }

        function loadAttendance() {
            db.ref('attendanceRecords').limitToLast(100).on('value', snap => {
                const tbody = document.getElementById('attendance-body');
                tbody.innerHTML = '';
                const data = snap.val();

                if (data) {
                    Object.keys(data).reverse().forEach(key => {
                        const rec = data[key];
                        tbody.innerHTML += `
                            <tr>
                                <td style="font-weight:700;">${rec.studentName}</td>
                                <td><span class="badge" style="background:rgba(99,102,241,0.1); color:var(--primary);">${rec.subject}</span></td>
                                <td>${rec.date}</td>
                                <td>${rec.time}</td>
                                <td><span class="badge badge-success">ุญุงุถุฑ</span></td>
                                <td class="no-print">
                                    <button onclick="deleteRecord('${key}')" style="background:none; border:none; cursor:pointer;" title="ุญุฐู">๐๏ธ</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            });
        }

        // 3. Deep Enhancement: Sync Task & Export
        function exportData() {
            db.ref('attendanceRecords').once('value', (snap) => {
                const data = snap.val();
                if (!data) {
                    alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "Student Name,Subject,Date,Time,Status\n";

                Object.values(data).forEach(row => {
                    csvContent += `${row.studentName},${row.subject},${row.date},${row.time},Attended\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "attendance_report_" + new Date().toISOString().split('T')[0] + ".csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        async function syncStudentsToCloud() {
            if (!confirm('ุชูุจูู: ุณูููู ูุฐุง ุงูุฅุฌุฑุงุก ุจุฅุนุงุฏุฉ ุชุนููู ูุงุนุฏุฉ ุจูุงูุงุช ุงูุทูุงุจ ุงูุณุญุงุจูุฉ ุจุงูุจูุงูุงุช ุงููุญููุฉ. ูู ุฃูุช ูุชุฃูุฏุ')) return;

            try {
                const studentsRef = db.ref('students_list');
                await studentsRef.set(localStudents);
                alert('โ ุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ ุจูุฌุงุญ.');
                location.reload();
            } catch (e) {
                console.error(e);
                alert('ุฎุทุฃ ูู ุงููุฒุงููุฉ');
            }
        }

        function updateStats() {
            document.getElementById('stat-total-students').innerText = currentStudentList.length;

            // Live Daily Count
            const today = new Date().toISOString().split('T')[0];
            db.ref('attendanceRecords').orderByChild('date').equalTo(today).on('value', snap => {
                document.getElementById('stat-today-scans').innerText = snap.numChildren();
            });
        }

        function deleteRecord(id) {
            if (confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุณุฌูุ')) {
                db.ref('attendanceRecords/' + id).remove();
            }
        }

        checkAuth();
    </script>
</body>

</html>