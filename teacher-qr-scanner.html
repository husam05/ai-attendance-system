<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | Ù…Ø§Ø³Ø­ Ø§Ù„Ø­Ø¶ÙˆØ± (Advanced)</title>
    <link rel="stylesheet" href="style.css">

    <!-- New Ultra-Fast Engine: Local Nimiq QR Scanner -->
    <script src="js/qr-scanner.umd.min.js"></script>
    <script>
        // Set worker path immediately after load
        if (typeof QrScanner !== 'undefined') {
            QrScanner.WORKER_PATH = 'js/qr-scanner-worker.min.js';
        }
    </script>

    <!-- Firebase -->
    <!-- Go Backend -->
    <script src="js/api.js"></script>

    <style>
        /* Camera Viewport */
        .camera-wrapper {
            position: relative;
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 0 1px #333;
            background: #000;
            aspect-ratio: 3/4;
            /* Mobile-first aspect ratio */
        }

        /* The actual video element */
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Overlay UI */
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            /* Dim surroundings */
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .scan-frame {
            width: 70%;
            aspect-ratio: 1;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            position: relative;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
            /* Hard focus effect */
        }

        .scan-frame::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #00ff88;
            border-radius: 20px;
            z-index: 2;
            opacity: 0.8;
            animation: pulse-border 2s infinite;
        }

        .scan-laser {
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 2px;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
            animation: scan-move 2s infinite linear;
        }

        @keyframes scan-move {
            0% {
                top: 5%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 95%;
                opacity: 0;
            }
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(0, 255, 136, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0);
            }
        }

        /* Status Badge */
        .status-pill {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
            /* Default off */
        }

        .status-dot.active {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
    </style>
</head>

<body>
    <div class="container animate-fade-in">
        <nav class="app-nav">
            <div class="nav-content">
                <div style="font-weight: 900; font-size: 1.5rem;"><span style="color: var(--primary);">DEEP</span> AI
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="attendance-management.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a></li>
                    <li><a href="attendance-report.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                </ul>
            </div>
        </nav>

        <div class="scanner-layout">
            <div class="glass-card" style="padding: 1.5rem;">
                <h2 style="margin-bottom: 1.5rem; display:flex; justify-content:space-between; align-items: center;">
                    <span>ğŸ“¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø°ÙƒÙŠØ© (v3.0)</span>
                    <div style="display:flex; gap:10px;">
                        <span id="connection-status" class="badge badge-danger" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">ğŸ“¡..</span>
                        <span id="scan-counter" class="badge badge-primary">0</span>
                    </div>
                </h2>

                <!-- Settings -->
                <div class="scanner-controls"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <select id="subject" class="form-control">
                        <option>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</option>
                        <option>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª I</option>
                        <option>Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</option>
                        <option>Ø§Ø®ØªØ¨Ø§Ø±</option>
                    </select>
                    <select id="lectureType" class="form-control">
                        <option>Ù†Ø¸Ø±ÙŠ</option>
                        <option>Ø¹Ù…Ù„ÙŠ</option>
                    </select>
                </div>

                <!-- New Camera System -->
                <div class="camera-wrapper">
                    <video id="qr-video"></video>

                    <div class="scan-overlay">
                        <div class="scan-frame">
                            <div class="scan-laser"></div>
                        </div>
                    </div>

                    <div class="status-pill">
                        <div id="cam-dot" class="status-dot"></div>
                        <span id="cam-status">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙˆÙ‚ÙØ©</span>
                    </div>
                </div>

                <!-- Controls -->
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="startCamera()" style="flex:1;">âš¡ ØªØ´ØºÙŠÙ„</button>
                    <button class="btn btn-secondary" onclick="stopCamera()" style="flex:1;">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button class="btn btn-secondary" onclick="toggleFlash()" id="flash-btn"
                        style="display:none;">ğŸ”¦</button>
                </div>

                <!-- Delegate Link Button -->
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="generateDelegateLink()" style="width: 100%;">
                        ğŸ“¤ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù„Ù„Ø·Ù„Ø§Ø¨
                    </button>
                </div>
            </div>

            <!-- List -->
            <div class="glass-card" style="padding: 1.5rem;">
                <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù„Ø­Ø¸ÙŠ</h3>
                <div id="recent-list" class="recent-scans" style="margin-top:1rem; min-height:200px;">
                    <div style="text-align:center; color:var(--text-muted); margin-top:3rem;">
                        ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audios -->
    <audio id="beepOk" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="beepFail" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>

    <script>
        // --- Firebase Setup ---
        // --- Local Setup ---
        const firebaseConfig = {};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Anonymous Authentication & Connection Test ---
        let isAuthenticated = false;
        let isDbConnected = false;
        let lastError = "No errors yet";
        const statusBadge = document.getElementById('connection-status');

        // Debug Click Handler
        statusBadge.addEventListener('click', () => {
            alert(`ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ù†Ø¸Ø§Ù…:\n\nğŸ‘¤ Ù…ØµØ§Ø¯Ù‚Ø©: ${isAuthenticated ? "ØªÙ… (ID: " + firebase.auth().currentUser?.uid.slice(0, 5) + "...)" : "âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„"}\nğŸ“¡ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${isDbConnected ? "âœ… Ù…ØªØµÙ„" : "âŒ Ù…Ù‚Ø·ÙˆØ¹"}\nğŸŒ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØµÙØ­: ${navigator.onLine ? "Online" : "Offline"}\nâš ï¸ Ø¢Ø®Ø± Ø®Ø·Ø£: ${lastError}`);
        });

        function updateStatusUI() {
            if (isAuthenticated && isDbConnected) {
                statusBadge.innerText = "âœ… Ù…ØªØµÙ„";
                statusBadge.className = "badge badge-success";
            } else if (!navigator.onLine) {
                statusBadge.innerText = "âš ï¸ Ø¨Ù„Ø§ Ø¥Ù†ØªØ±Ù†Øª";
                statusBadge.className = "badge badge-danger";
            } else if (!isAuthenticated) {
                statusBadge.innerText = "ğŸ‘¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...";
                statusBadge.className = "badge badge-warning";
            } else {
                statusBadge.innerText = "ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø·...";
                statusBadge.className = "badge badge-warning";
            }
        }

        // 1. Monitor Auth State (More robust than promise)
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                console.log("âœ… Auth State: Logged in", user.uid);
                isAuthenticated = true;
                updateStatusUI();
            } else {
                console.log("âš ï¸ Auth State: Logged out, retrying...");
                isAuthenticated = false;
                firebase.auth().signInAnonymously().catch(e => {
                    lastError = e.message;
                    updateStatusUI();
                });
            }
        });

        // 2. Continuous Latency Check
        const connectedRef = firebase.database().ref(".info/connected");
        connectedRef.on("value", (snap) => {
            isDbConnected = snap.val() === true;
            console.log("ğŸ“¡ DB Connection change:", isDbConnected);
            if (!isDbConnected && isAuthenticated) lastError = "Database disconnected (Timeout/Network)";
            updateStatusUI();
        });

        // Initial Error Catch
        window.addEventListener('error', (event) => {
            lastError = event.reason || event.message;
        });
        // --- New Scanner Engine ---
        let qrScanner = null;
        let isScanned = false; // Lock
        let scanCount = 0;
        let scannedIds = new Set(); // Session duplicates

        // Elements
        const videoElem = document.getElementById('qr-video');
        const statusText = document.getElementById('cam-status');
        const statusDot = document.getElementById('cam-dot');
        const flashBtn = document.getElementById('flash-btn');

        // 1. Initialize logic
        async function startCamera() {
            // Check if QrScanner is available
            if (typeof QrScanner === 'undefined') {
                statusText.innerText = "Ø®Ø·Ø£: Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø§Ø³Ø­ ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©";
                statusText.style.color = "#ff4444";
                alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© QR Scanner. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù js/qr-scanner.umd.min.js");
                return;
            }

            if (qrScanner) {
                qrScanner.start();
                updateUI(true);
                return;
            }

            // Create Scanner Instance
            qrScanner = new QrScanner(
                videoElem,
                result => processResult(result),
                {
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                    maxScansPerSecond: 5, // Throttle
                    returnDetailedScanResult: true // Get full object
                }
            );

            try {
                await qrScanner.start();
                updateUI(true);

                // Check flash support
                if (await qrScanner.hasFlash()) {
                    flashBtn.style.display = 'block';
                }
            } catch (e) {
                console.error("Camera Error:", e);
                statusText.innerText = "ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
                statusText.style.color = "#ff4444";

                // More detailed error message
                let errorMsg = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ";
                if (e.name === 'NotAllowedError') {
                    errorMsg += "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.";
                } else if (e.name === 'NotFoundError') {
                    errorMsg += "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØµÙ„Ø©.";
                } else {
                    errorMsg += e.message || e;
                }
                alert(errorMsg);
            }
        }

        function stopCamera() {
            if (qrScanner) {
                qrScanner.stop();
                updateUI(false);
            }
        }

        function toggleFlash() {
            if (qrScanner) qrScanner.toggleFlash();
        }

        function updateUI(active) {
            statusText.innerText = active ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­..." : "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙˆÙ‚ÙØ©";
            statusDot.className = active ? "status-dot active" : "status-dot";
        }

        // Helper function to decode HTML entities
        function decodeHTMLEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        // 2. Process Scan (Logic Only)
        async function processResult(result) {
            if (isScanned) return; // Debounce lock

            let rawText = result.data;

            // Decode HTML entities if present (fixes Arabic encoding issues)
            if (rawText.includes('&')) {
                rawText = decodeHTMLEntities(rawText);
            }

            let student = null;

            try {
                student = JSON.parse(rawText);

                // Decode HTML entities in student data
                if (student.name && student.name.includes('&')) {
                    student.name = decodeHTMLEntities(student.name);
                }
                if (student.department && student.department.includes('&')) {
                    student.department = decodeHTMLEntities(student.department);
                }
                if (student.university && student.university.includes('&')) {
                    student.university = decodeHTMLEntities(student.university);
                }
            } catch (e) {
                // Not a JSON QR - Attempt Legacy/Plain Text Mode
                console.log("âš ï¸ Standard JSON parse failed, attempting plain text...");
                if (typeof rawText === 'string' && rawText.length > 2) {
                    // Assume the text ITSELF is the student name or ID
                    student = {
                        id: "legacy_" + Math.random().toString(36).substr(2, 9),
                        name: decodeHTMLEntities(rawText.trim()), // Use the raw text as name
                        type: 'legacy_plain'
                    };
                } else {
                    return;
                }
            }

            if (!student.id || !student.name) return;

            // Log for debugging (properly formatted)
            console.log("âœ… Scanned Student:", {
                id: student.id,
                name: student.name,
                department: student.department || 'N/A'
            });

            // Check Session Duplicate
            if (scannedIds.has(student.id)) {
                showToast(`âš ï¸ ${student.name} Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹`, 'warning');
                isScanned = true;
                setTimeout(() => isScanned = false, 2000); // 2s Cooldown
                return;
            }

            // --- Success Path ---
            isScanned = true;
            confirmScan(student);
        }

        function confirmScan(student) {
            // 1. Visual/Audio Feedback
            document.getElementById('beepOk').play().catch(() => { });
            const frame = document.querySelector('.scan-frame');
            frame.style.borderColor = '#00ff88';
            setTimeout(() => frame.style.borderColor = 'rgba(255,255,255,0.5)', 500);

            // 2. Add to Local List
            scannedIds.add(student.id);
            scanCount++;
            document.getElementById('scan-counter').innerText = scanCount;
            addToList(student.name);

            // 3. Save to Firebase
            const record = {
                studentId: student.id,
                studentName: student.name,
                subject: document.getElementById('subject').value,
                lectureType: document.getElementById('lectureType').value,
                date: new Date().toLocaleDateString('en-CA'),
                time: new Date().toLocaleTimeString('ar-EG'),
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                engine: 'Nimiq_v1'
            };

            db.ref('attendanceRecords').push(record)
                .then(() => {
                    console.log("âœ… Saved to Firebase:", record);
                })
                .catch(e => {
                    console.error("âŒ Firebase Save Error:", e);
                    showToast(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message || e}`, "danger");
                });

            // Also save to localStorage as backup
            const localRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            localRecords.push({ ...record, timestamp: Date.now() });
            localStorage.setItem('attendanceRecords', JSON.stringify(localRecords));

            // 4. Release Lock
            showToast(`âœ… ${student.name}`, 'success');
            setTimeout(() => isScanned = false, 1500); // 1.5s delay before next scan
        }

        function addToList(name) {
            const list = document.getElementById('recent-list');
            const item = document.createElement('div');
            item.className = 'scan-item success';

            // Create a temporary element to decode HTML entities
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = name;
            const decodedName = tempDiv.textContent || tempDiv.innerText || name;

            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <strong>${decodedName}</strong>
                    <small>${new Date().toLocaleTimeString('ar-EG')}</small>
                </div>
            `;
            // Remove empty msg if exists
            const emptyMsg = list.querySelector('[style*="text-align:center"]');
            if (emptyMsg) emptyMsg.remove();

            list.prepend(item);
        }

        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `badge badge-${type}`;
            t.style.position = 'fixed';
            t.style.top = '100px';
            t.style.left = '50%';
            t.style.transform = 'translateX(-50%)';
            t.style.zIndex = 999;
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        // Generate Delegate Scanner Link
        async function generateDelegateLink() {
            const subject = document.getElementById('subject').value;
            const lectureType = document.getElementById('lectureType').value;

            const expiresInMinutes = prompt('Ù…Ø¯Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚:', '30');
            if (!expiresInMinutes) return;

            try {
                const response = await fetch('/api/session/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: subject,
                        lectureType: lectureType,
                        expiresInMinutes: parseInt(expiresInMinutes)
                    })
                });

                if (!response.ok) throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·');

                const data = await response.json();

                // Show link in modal/alert
                const expiresDate = new Date(data.expiresAt);
                const message = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·!\n\nØ§Ù„Ø±Ø§Ø¨Ø·:\n${data.url}\n\nÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${expiresDate.toLocaleString('ar-EG')}\n\nØ§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø·Ù„Ø§Ø¨`;

                // Copy to clipboard
                navigator.clipboard.writeText(data.url).then(() => {
                    alert(message + '\n\nâœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!');
                    showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·', 'success');
                }).catch(() => {
                    alert(message);
                });

            } catch (e) {
                console.error('Error generating link:', e);
                showToast('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·', 'danger');
            }
        }
    </script>
</body>

</html>