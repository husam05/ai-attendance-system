<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | Ù…Ø§Ø³Ø­ Ù…Ø¤Ù‚Øª</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        #reader {
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--glass-border);
            background: #000;
        }

        .timer-badge {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 0.75rem 1.5rem;
            border-radius: 100px;
            font-weight: 700;
            display: inline-block;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <!-- Verifying Overlay -->
    <div id="verify-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ”’</div>
            <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·...</h2>
        </div>
    </div>

    <!-- Error View -->
    <div id="error-view"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">â›”</div>
            <h1 id="error-msg">Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</h1>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <div class="container animate-fade-in">
            <div class="glass-card" style="padding: 2.5rem; text-align: center; margin-bottom: 2rem;">
                <h1 style="margin-bottom: 1rem;">ğŸ“¸ Ù…Ø§Ø³Ø­ Ø§Ù„Ø­Ø¶ÙˆØ± (ÙˆØ¶Ø¹ Ù…ÙÙˆØ¶)</h1>
                <div class="badge badge-success">Ø·Ø§Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯</div>
                <div class="timer-badge" id="expiry-timer">ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: --:--</div>
            </div>

            <div class="glass-card" style="padding: 2rem; margin-bottom: 2rem;">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Ø§Ù„Ù…Ø§Ø¯Ø©
                        Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                    <select id="subject" class="form-control">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©...</option>
                        <option>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</option>
                        <option>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª I</option>
                        <option>Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</option>
                        <option>Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†</option>
                        <option>Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©</option>
                        <option>Ø§Ù„Ø¥Ø­ØµØ§Ø¡ ÙˆØ§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª</option>
                    </select>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</label>
                    <select id="lectureType" class="form-control">
                        <option>Ù†Ø¸Ø±ÙŠ</option>
                        <option>Ø¹Ù…Ù„ÙŠ</option>
                    </select>
                </div>

                <div id="alertContainer" style="margin-bottom: 1rem;"></div>

                <div id="reader" style="margin-bottom: 1.5rem;"></div>

                <div style="display: flex; gap: 1rem;">
                    <button id="startBtn" class="btn btn-primary" onclick="startScanner()" style="flex: 1;">Ø¨Ø¯Ø¡
                        Ø§Ù„Ù…Ø³Ø­</button>
                    <button id="stopBtn" class="btn btn-secondary" onclick="stopScanner()"
                        style="flex: 1; display: none;">Ø¥ÙŠÙ‚Ø§Ù</button>
                </div>
            </div>

            <div class="glass-card" style="padding: 2rem;">
                <h3>âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ù…: <span id="count">0</span></h3>
                <div id="recent-scans" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLSX6DY_79BD8ZEYBRYh_jtmP0mHslzkE",
            authDomain: "ai-attendance-husam.firebaseapp.com",
            databaseURL: "https://ai-attendance-husam-default-rtdb.firebaseio.com",
            projectId: "ai-attendance-husam",
            storageBucket: "ai-attendance-husam.firebasestorage.app",
            messagingSenderId: "305903941972",
            appId: "1:305903941972:web:d914431aab5a1cc6b5b0c1",
            measurementId: "G-EJEKCTT2M9"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let html5QrCode = null;
        let sessionCount = 0;

        async function checkToken() {
            if (!token) return showFatalError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ (No Token)');

            try {
                const snap = await database.ref('temp_tokens/' + token).once('value');
                if (!snap.exists()) return showFatalError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡');

                const data = snap.val();
                if (Date.now() > data.expiry) return showFatalError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·');

                document.getElementById('verify-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                startTimer(data.expiry);

                // Pre-fill subject if provided
                if (data.subject) document.getElementById('subject').value = data.subject;
                if (data.lectureType) document.getElementById('lectureType').value = data.lectureType;

            } catch (e) {
                console.error(e);
                showFatalError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        function showFatalError(msg) {
            document.getElementById('verify-overlay').style.display = 'none';
            document.getElementById('error-view').style.display = 'flex';
            document.getElementById('error-msg').textContent = msg;
        }

        function startTimer(expiryTime) {
            setInterval(() => {
                const diff = expiryTime - Date.now();
                if (diff <= 0) {
                    showFatalError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·');
                    stopScanner();
                    return;
                }
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('expiry-timer').textContent = `ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            }, 1000);
        }

        function startScanner() {
            const subject = document.getElementById('subject').value;
            if (!subject) return showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).then(() => {
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                });
            }
        }

        const scannedIds = new Set();
        const processingIds = new Set();

        async function onScanSuccess(decodedText) {
            let student;
            try {
                student = JSON.parse(decodedText);
                if (!student.id || !student.name) return;
            } catch (e) {
                return;
            }

            if (scannedIds.has(student.id)) return;
            if (processingIds.has(student.id)) return;

            processingIds.add(student.id);
            html5QrCode.pause(); // Pause scanning while checking

            try {
                const subject = document.getElementById('subject').value;
                const today = new Date().toISOString().split('T')[0];

                // Check for duplicates in cloud
                const snapshot = await database.ref('attendanceRecords')
                    .orderByChild('date')
                    .equalTo(today)
                    .once('value');

                let isDuplicate = false;
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const rec = child.val();
                        if (rec.studentId === student.id && rec.subject === subject) {
                            isDuplicate = true;
                        }
                    });
                }

                if (isDuplicate) {
                    showAlert(`âš ï¸ ${student.name} Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©`, 'warning');
                    scannedIds.add(student.id);
                } else {
                    await recordAttendance(student);
                }

            } catch (e) {
                console.error(e);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'danger');
            } finally {
                processingIds.delete(student.id);
                setTimeout(() => html5QrCode.resume(), 1500); // Resume after short delay
            }
        }

        async function recordAttendance(studentData) {
            const record = {
                studentId: studentData.id,
                studentName: studentData.name,
                subject: document.getElementById('subject').value,
                lectureType: document.getElementById('lectureType').value,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('ar-EG'),
                timestamp: Date.now(),
                via_token: token,
                collectedBy: 'delegate'
            };

            await database.ref('attendanceRecords').push(record);

            showAlert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„: ${studentData.name}`, 'success');
            scannedIds.add(studentData.id);
            sessionCount++;
            document.getElementById('count').textContent = sessionCount;

            const div = document.createElement('div');
            div.style.padding = '0.75rem';
            div.style.borderBottom = '1px solid var(--glass-border)';
            div.innerHTML = `<strong>${studentData.name}</strong> <span style="color: var(--text-muted); font-size: 0.85rem;">${record.time}</span>`;
            document.getElementById('recent-scans').prepend(div);
        }

        function showAlert(msg, type) {
            const colors = {
                success: 'var(--success)',
                danger: 'var(--danger)',
                warning: 'var(--warning)'
            };
            const div = document.createElement('div');
            div.style.padding = '1rem';
            div.style.background = `rgba(${type === 'success' ? '16, 185, 129' : type === 'danger' ? '239, 68, 68' : '245, 158, 11'}, 0.1)`;
            div.style.border = `1px solid ${colors[type]}`;
            div.style.borderRadius = '12px';
            div.style.color = colors[type];
            div.textContent = msg;
            document.getElementById('alertContainer').innerHTML = '';
            document.getElementById('alertContainer').appendChild(div);
        }

        checkToken();
    </script>
</body>

</html>