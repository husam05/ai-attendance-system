<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | Ù…Ø§Ø³Ø­ Ù…Ø¤Ù‚Øª</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        #reader {
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--glass-border);
            background: #000;
            position: relative;
        }

        #reader video {
            object-fit: cover !important;
        }

        .timer-badge {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 0.75rem 1.5rem;
            border-radius: 100px;
            font-weight: 700;
            display: inline-block;
            margin-top: 1rem;
        }

        .scan-flash {
            position: absolute;
            inset: 0;
            background: rgba(16, 185, 129, 0.4);
            z-index: 20;
            opacity: 0;
            pointer-events: none;
        }

        .flash-active {
            animation: flashAnim 0.3s ease-out;
        }

        @keyframes flashAnim {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Verifying Overlay -->
    <div id="verify-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;">ğŸ”’</div>
            <h2 id="verify-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·...</h2>
            <p style="color: var(--text-muted); margin-top: 1rem;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø©</p>
            <button id="retry-btn" class="btn btn-secondary" style="display: none; margin-top: 2rem;"
                onclick="location.reload()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        </div>
    </div>

    <!-- Error View -->
    <div id="error-view"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">â›”</div>
            <h1 id="error-msg">Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</h1>
            <p style="color: var(--text-muted); margin-top: 1rem;">ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø³ØªØ§Ø°</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <div class="container animate-fade-in">
            <div class="glass-card" style="padding: 2.5rem; text-align: center; margin-bottom: 2rem;">
                <h1 style="margin-bottom: 1rem;">ğŸ“¸ Ù…Ø§Ø³Ø­ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…ÙÙˆØ¶)</h1>
                <div class="badge badge-success">Ø¬Ù„Ø³Ø© Ø·Ø§Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯</div>
                <div class="timer-badge" id="expiry-timer">ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: --:--</div>
            </div>

            <div class="glass-card" style="padding: 2rem; margin-bottom: 2rem;">
                <!-- Controls -->
                <div class="scanner-controls"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Ø§Ù„Ù…Ø§Ø¯Ø©
                            Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                        <select id="subject" class="form-control" disabled>
                            <option value="">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                        </select>
                    </div>
                    <div>
                        <label
                            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Ù†ÙˆØ¹
                            Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</label>
                        <select id="lectureType" class="form-control" disabled>
                            <option>Ù†Ø¸Ø±ÙŠ</option>
                            <option>Ø¹Ù…Ù„ÙŠ</option>
                        </select>
                    </div>
                </div>

                <div id="alertContainer" style="margin-bottom: 1rem;"></div>

                <div style="position: relative; border-radius: var(--radius-md); overflow: hidden;">
                    <div id="reader" style="width: 100%;"></div>
                    <div class="scan-flash" id="scanFlash"></div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="startBtn" class="btn btn-primary" onclick="startScanner()" style="flex: 1;">âš¡ Ø¨Ø¯Ø¡
                        Ø§Ù„Ù…Ø³Ø­</button>
                    <button id="stopBtn" class="btn btn-secondary" onclick="stopScanner()"
                        style="flex: 1; display: none;">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù</button>
                </div>
            </div>

            <div class="glass-card" style="padding: 2rem;">
                <h3>âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ù…: <span id="count" style="color: var(--primary); font-weight: 900;">0</span></h3>
                <div id="recent-scans" style="margin-top: 1rem; max-height: 250px; overflow-y: auto;">
                    <div id="empty-state"
                        style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">
                        Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø·Ø§Ù„Ø¨ Ø¨Ø¹Ø¯
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Feedback Assets -->
    <audio id="beepSuccess" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="beepError" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLSX6DY_79BD8ZEYBRYh_jtmP0mHslzkE",
            authDomain: "ai-attendance-husam.firebaseapp.com",
            databaseURL: "https://ai-attendance-husam-default-rtdb.firebaseio.com",
            projectId: "ai-attendance-husam",
            storageBucket: "ai-attendance-husam.firebasestorage.app",
            messagingSenderId: "305903941972",
            appId: "1:305903941972:web:d914431aab5a1cc6b5b0c1",
            measurementId: "G-EJEKCTT2M9"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // --- State ---
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let html5QrCode = null;
        let sessionCount = 0;
        let validStudentsList = []; // Centralized Validation

        // Locks
        const scannedIds = new Set();
        const processingIds = new Set();

        // UI
        const successBeep = document.getElementById('beepSuccess');
        const errorBeep = document.getElementById('beepError');
        const scanFlash = document.getElementById('scanFlash');

        // --- Initialization ---

        window.onload = init;

        async function init() {
            // 1. Silent Auth
            auth.onAuthStateChanged(user => {
                if (!user) auth.signInAnonymously().catch(console.warn);
            });

            // 2. Load Validation List
            try {
                const snap = await database.ref('students_list').once('value');
                if (snap.exists()) validStudentsList = snap.val();
            } catch (e) { console.warn("List load error", e); }

            // 3. Validate Token
            await checkToken();
        }

        async function checkToken() {
            const statusEl = document.getElementById('verify-status');
            const retryBtn = document.getElementById('retry-btn');

            if (!token) return showFatalError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ (No Token Code)');

            // Timeout safety
            const timeout = setTimeout(() => {
                statusEl.textContent = 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø·ÙŠØ¡...';
                retryBtn.style.display = 'inline-flex';
            }, 10000);

            try {
                statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                const snap = await database.ref('temp_tokens/' + token).once('value');
                clearTimeout(timeout);

                if (!snap.exists()) return showFatalError('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØªÙ… Ø¥Ø¨Ø·Ø§Ù„Ù‡');

                const data = snap.val();
                if (Date.now() > data.expiry) return showFatalError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· (30 Ø¯Ù‚ÙŠÙ‚Ø©)');

                // Success
                document.getElementById('verify-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                startTimer(data.expiry);

                // Setup Context & Lock Filters
                const subjSelect = document.getElementById('subject');
                subjSelect.innerHTML = `<option value="${data.subject}">${data.subject}</option>`;

                if (data.lectureType) {
                    const typeSelect = document.getElementById('lectureType');
                    typeSelect.value = data.lectureType;
                }

            } catch (e) {
                clearTimeout(timeout);
                statusEl.textContent = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚';
                retryBtn.style.display = 'inline-flex';
                showFatalError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
            }
        }

        function showFatalError(msg) {
            document.getElementById('verify-overlay').style.display = 'none';
            document.getElementById('error-view').style.display = 'flex';
            document.getElementById('error-msg').textContent = msg;
        }

        function startTimer(expiryTime) {
            setInterval(() => {
                const diff = expiryTime - Date.now();
                if (diff <= 0) {
                    showFatalError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©');
                    stopScanner();
                    return;
                }
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('expiry-timer').textContent = `ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            }, 1000);
        }

        // --- Scanning Logic (Robust Engine) ---

        function startScanner() {
            const subject = document.getElementById('subject').value;
            if (!subject) return showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©', 'warning');

            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .then(() => {
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'block';
                    showToast('âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }).catch(err => {
                    console.error(err);
                    showToast('âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'danger');
                });
        }

        async function onScanSuccess(decodedText) {
            if (processingIds.size > 0) return;

            let student;
            try {
                student = JSON.parse(decodedText);
            } catch (e) { return; } // Ignore non-JSON

            // 1. Validation
            if (!student.id || !student.name) return;

            // Central Validation Check
            if (validStudentsList.length > 0 && !validStudentsList.includes(student.name)) {
                processError(`Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„: ${student.name}`, true);
                return;
            }

            if (scannedIds.has(student.id)) {
                processError(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${student.name} Ù…Ø³Ø¨Ù‚Ø§Ù‹`, true);
                return;
            }

            // 2. Lock
            processingIds.add(student.id);
            triggerFeedback('processing');

            try {
                const subject = document.getElementById('subject').value;
                const today = new Date().toLocaleDateString('en-CA');

                // 3. Cloud Duplicate Check
                let isCloudDuplicate = false;
                try {
                    const snap = await database.ref('attendanceRecords')
                        .orderByChild('date')
                        .equalTo(today)
                        .once('value');

                    if (snap.exists()) {
                        snap.forEach(child => {
                            const rec = child.val();
                            if (rec.studentId === student.id && rec.subject === subject) isCloudDuplicate = true;
                        });
                    }
                } catch (e) { console.warn("Offline duplicate check skipped"); }

                if (isCloudDuplicate) {
                    scannedIds.add(student.id);
                    processError(`Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ${student.name}`, true);
                    return;
                }

                // 4. Record
                const record = {
                    studentId: student.id,
                    studentName: student.name,
                    subject: subject,
                    lectureType: document.getElementById('lectureType').value,
                    date: today,
                    time: new Date().toLocaleTimeString('ar-EG'),
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    via_token: token,
                    collectedBy: 'delegate'
                };

                await database.ref('attendanceRecords').push(record);

                // 5. Success
                handleSuccess(student);

            } catch (e) {
                console.error(e);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'danger');
            } finally {
                setTimeout(() => processingIds.delete(student.id), 2000);
            }
        }

        function handleSuccess(student) {
            scannedIds.add(student.id);
            sessionCount++;
            document.getElementById('count').textContent = sessionCount;

            // List Update
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            const div = document.createElement('div');
            div.className = 'scan-item';
            div.style.padding = '0.75rem';
            div.style.borderBottom = '1px solid var(--glass-border)';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <div style="width:8px; height:8px; background:var(--success); border-radius:50%;"></div>
                    <strong>${student.name}</strong>
                </div>
                <span style="color:var(--text-muted); font-size:0.8rem;">${new Date().toLocaleTimeString('ar-EG')}</span>
            `;
            const list = document.getElementById('recent-scans');
            list.insertBefore(div, list.firstChild);

            triggerFeedback('success');
            showToast(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„: ${student.name}`, 'success');
        }

        function processError(msg, warn = false) {
            if (warn) {
                triggerFeedback('warning');
                showToast(`âš ï¸ ${msg}`, 'warning');
            }
        }

        function triggerFeedback(type) {
            if (navigator.vibrate) {
                if (type === 'success') navigator.vibrate([50, 50, 50]);
                if (type === 'warning') navigator.vibrate(200);
            }
            if (type === 'success') {
                scanFlash.classList.add('flash-active');
                setTimeout(() => scanFlash.classList.remove('flash-active'), 300);

                successBeep.currentTime = 0;
                successBeep.play().catch(() => { });
            }
            if (type === 'warning') {
                errorBeep.currentTime = 0;
                errorBeep.play().catch(() => { });
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'secondary');
                });
            }
        }

        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `badge badge-${type}`;
            toast.style.position = 'fixed';
            toast.style.bottom = '2rem';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.padding = '1rem 2rem';
            toast.style.zIndex = '9999';
            toast.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
            toast.style.whiteSpace = 'nowrap';
            toast.innerText = msg;

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>

</html>