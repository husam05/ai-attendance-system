<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .id-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: var(--transition);
        }

        .id-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
        }

        .id-header {
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .id-body {
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .qr-box {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        @media print {
            body {
                background: white !important;
            }

            .no-print {
                display: none !important;
            }

            .students-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }

            .id-card {
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .id-header {
                background: #eee !important;
                border-bottom: 1px solid #000;
            }
        }
    </style>
</head>

<body>
    <div class="container animate-fade-in">
        <nav class="app-nav no-print">
            <div class="nav-content">
                <div style="font-weight: 900; font-size: 1.5rem;"><span style="color: var(--primary);">DEEP</span> AI
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="teacher-qr-scanner.html">Ø§Ù„Ù…Ø§Ø³Ø­</a></li>
                    <li><a href="attendance-management.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a></li>
                    <li><a href="attendance-report.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                </ul>
            </div>
        </nav>

        <header class="header-section no-print">
            <h1 class="header-title">ğŸ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h1>
            <p class="header-subtitle">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…ÙˆØ² QR Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
        </header>

        <div class="glass-card no-print" style="padding: 2rem; margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="generateAllQRCodes()">ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ù…ÙˆØ²</button>
                <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
            </div>
        </div>

        <div class="students-grid" id="studentsGrid"></div>
    </div>

    <!-- Go Backend -->
    <script src="js/api.js"></script>

    <!-- html-to-image & QRious -->
    <!-- html-to-image & QRious (Local) -->
    <script src="js/html-to-image.min.js"></script>
    <script src="js/qrious.min.js"></script>

    <script>
        const localStudents = [
            "ÙŠÙˆØ³Ù Ù…ÙŠØ«Ø§Ù‚ Ø·Ø§Ù„Ø¨ Ø¹Ø¬ÙŠÙ„", "Ø­Ø³ÙŠÙ† Ø¹Ù„ÙŠ Ø¯ÙˆØ´Ø§Ù† ÙƒØ§Ø¸Ù…", "Ù†ÙˆØ±Ø§Ù„Ø­Ø³Ù† Ø¨Ø§Ø³Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø²Ø§Ù‚ Ø­Ø³ÙŠÙ†",
            "Ù…ØµØ·ÙÙ‰ ÙØ¤Ø§Ø¯ ÙØ§Ø¶Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ø§Ù…ÙŠØ±", "Ø¹Ù„ÙŠ Ø¬Ù…Ø§Ù„ Ø®Ù„Ù ÙØ¹ÙŠÙ„", "Ù…ØµØ·ÙÙ‰ Ù…Ø­Ù…Ø¯ Ù…Ø±Ø¯Ø§Ù† Ø­Ø³Ù†",
            "Ø¶Ø­Ù‰ Ø­ÙŠØ¯Ø± ÙƒÙ…Ø§Ù„ Ø¬ÙˆØ¯Ù‡", "Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø¬Ø¨Ø§Ø± Ø­Ø³ÙŠÙ†", "Ø¨Ù†ÙŠÙ† Ø¯ÙŠØ§Ø± Ø±Ø­ÙŠÙ… ØµÙØ±",
            "Ø²Ù‡Ø±Ø§Ø¡ Ù…Ø­Ù…Ø¯ Ø³Ø±ÙŠØ­ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ø³Ù†", "Ø²Ù‡Ø±Ø§Ø¡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ù‡Ø¯ÙŠ Ø®Ø¶ÙŠØ±", "Ù…Ù†ØªØ¸Ø± Ø­Ù…ÙŠØ¯ Ø¹Ø°Ø§Ø¨ Ø¶Ø§Ø­ÙŠ",
            "Ù†Ø¨Ø£ Ø¬Ø§Ø³Ù… Ø±Ø­Ù…Ù‡ Ø´Ø§ÙŠØ¹", "Ù…Ø¹ØµÙˆÙ…Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ø³ÙŠÙ† Ø¬Ø¨Ø§Ø± Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", "Ø¯Ø§Ù„ÙŠØ§ ÙƒØ±ÙŠÙ… Ù„ÙŠÙ„Ùˆ Ù…Ù†ØµÙˆØ±",
            "Ù…Ø¤Ù…Ù„ Ø³Ø¹Ø¯ÙˆÙ† Ø¬Ø¨Ø§Ø± Ù„ÙØªÙ‡", "Ø³Ø¨Ø£ Ù…Ø­Ù…Ø¯ ØµØ¨Ø±ÙŠ Ø³Ù„Ø·Ø§Ù†", "Ø±Ù‚ÙŠÙ‡ Ø§Ø«ÙŠØ± Ø§Ø­Ù…Ø¯ Ù…Ø·Ù„Ù‚", "ÙƒØ§Ø¸Ù… Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø³Ù…"
        ];

        // Firebase Config
        // Local Setup
        const firebaseConfig = {};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let studentsList = [];

        function generateStudentId(index) {
            return `2025-AI-${String(index + 1).padStart(3, '0')}`;
        }

        function generateAllQRCodes() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = '';

            const listToUse = studentsList.length > 0 ? studentsList : localStudents;

            listToUse.forEach((student, index) => {
                const studentId = generateStudentId(index);

                // Create QR data with PURE TEXT (no HTML encoding)
                // This must be done BEFORE any HTML insertion
                const qrData = JSON.stringify({
                    id: studentId,
                    name: student,  // Pure text, not HTML-encoded
                    department: "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
                    university: "Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…ØµØ·ÙÙ‰"
                });

                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'glass-card';

                // Actual downloadable ID Card
                const card = document.createElement('div');
                card.id = `card-${index}`;
                card.className = 'id-card';
                card.style.position = 'relative';
                // Premium Dark Theme Background with Subtle Gradient
                card.style.background = 'linear-gradient(180deg, #1e293b 0%, #0f172a 100%)';
                // Force font family and direction explicitly for the capture
                card.style.fontFamily = "'Cairo', 'Tajawal', sans-serif";

                card.innerHTML = `
                    <div class="id-header">
                        <div style="color: white; font-weight: 900; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">AI DEPT</div>
                    </div>
                    <div class="id-body" style="color: white; padding-top: 1.5rem;" dir="rtl" lang="ar">
                        <div style="width: 80px; height: 80px; background: rgba(99,102,241,0.15); border: 2px solid rgba(99,102,241,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                            ğŸ‘¤
                        </div>
                        
                        <!-- Name with improved contrast background -->
                        <div style="padding: 0.5rem 0; margin-bottom: 0.5rem;">
                            <h3 id="student-name-${index}" style="margin: 0; font-size: 1.4rem; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-family: 'Cairo', sans-serif; direction: rtl; unicode-bidi: normal;"></h3>
                        </div>
                        
                        <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1.5rem; letter-spacing: 0.5px;">Ù‚Ø³Ù… Ø¹Ù„ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                        
                        <!-- QR Container -->
                        <div style="background: white; padding: 12px; border-radius: 16px; display: inline-block; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);">
                            <canvas id="qr-${index}"></canvas>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <div class="badge" style="background: var(--primary); color: white; padding: 0.5rem 1.5rem; border-radius: 100px; display: inline-block; font-family: 'Courier New', monospace; font-weight: 700; letter-spacing: 1px; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4);">
                                ${studentId}
                            </div>
                        </div>
                    </div>
                `;

                // Set student name using textContent to avoid HTML encoding
                const nameElement = card.querySelector(`#student-name-${index}`);
                if (nameElement) {
                    nameElement.textContent = student;
                }

                cardWrapper.appendChild(card);

                // Download Button
                const btnContainer = document.createElement('div');
                btnContainer.className = 'no-print';
                btnContainer.style.padding = '1rem';
                btnContainer.style.textAlign = 'center';
                btnContainer.innerHTML = `
                    <button class="btn btn-secondary" onclick="downloadCard(${index}, '${student}')" style="width: 100%; font-size: 0.9rem;">
                        â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                    </button>
                `;
                cardWrapper.appendChild(btnContainer);

                grid.appendChild(cardWrapper);

                // Generate QR Code Locally with QRious
                setTimeout(() => {
                    const canvas = document.getElementById(`qr-${index}`);
                    if (canvas) {
                        new QRious({
                            element: canvas,
                            value: qrData,
                            size: 300, // Increased size for High-Res
                            level: 'H'
                        });
                    }
                }, 0);
            });
        }

        async function downloadCard(index, studentName) {
            const cardElement = document.getElementById(`card-${index}`);
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

            try {
                // Ensure fonts area ready
                await document.fonts.ready;

                // Use html-to-image instead of html2canvas
                const dataUrl = await htmlToImage.toPng(cardElement, {
                    quality: 1.0,
                    pixelRatio: 3, // High resolution
                    backgroundColor: null // Preserve transparency/gradient
                });

                const link = document.createElement('a');
                link.download = `ID_${studentName.replace(/\s+/g, '_')}.png`;
                link.href = dataUrl;
                link.click();

                btn.innerText = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                setTimeout(() => btn.innerText = originalText, 2000);
            } catch (err) {
                console.error("Download Error:", err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
                btn.innerText = originalText;
            }
        }

        async function fetchStudents() {
            try {
                const snap = await db.ref('students_list').once('value');
                if (snap.exists() && Array.isArray(snap.val())) {
                    studentsList = snap.val();
                } else {
                    studentsList = localStudents;
                }
            } catch (error) {
                console.error("Error loading students:", error);
                studentsList = localStudents;
            }
            generateAllQRCodes();
        }

        window.addEventListener('load', () => {
            // Delay slightly to ensure fonts load
            setTimeout(fetchStudents, 500);
        });
    </script>
</body>

</html>