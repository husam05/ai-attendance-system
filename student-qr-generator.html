<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .id-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: var(--transition);
        }

        .id-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
        }

        .id-header {
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .id-body {
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .qr-box {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        @media print {
            body {
                background: white !important;
            }

            .no-print {
                display: none !important;
            }

            .students-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }

            .id-card {
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .id-header {
                background: #eee !important;
                border-bottom: 1px solid #000;
            }
        }
    </style>
</head>

<body>
    <div class="container animate-fade-in">
        <nav class="app-nav no-print">
            <div class="nav-content">
                <div style="font-weight: 900; font-size: 1.5rem;"><span style="color: var(--primary);">DEEP</span> AI
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="teacher-qr-scanner.html">Ø§Ù„Ù…Ø§Ø³Ø­</a></li>
                    <li><a href="attendance-management.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a></li>
                    <li><a href="attendance-report.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                </ul>
            </div>
        </nav>

        <header class="header-section no-print">
            <h1 class="header-title">ğŸ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h1>
            <p class="header-subtitle">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…ÙˆØ² QR Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
        </header>

        <div class="glass-card no-print" style="padding: 2rem; margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="generateAllQRCodes()">ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ù…ÙˆØ²</button>
                <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
            </div>
        </div>

        <div class="students-grid" id="studentsGrid"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        const localStudents = [
            "ÙŠÙˆØ³Ù Ù…ÙŠØ«Ø§Ù‚ Ø·Ø§Ù„Ø¨ Ø¹Ø¬ÙŠÙ„", "Ø­Ø³ÙŠÙ† Ø¹Ù„ÙŠ Ø¯ÙˆØ´Ø§Ù† ÙƒØ§Ø¸Ù…", "Ù†ÙˆØ±Ø§Ù„Ø­Ø³Ù† Ø¨Ø§Ø³Ù… Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø²Ø§Ù‚ Ø­Ø³ÙŠÙ†",
            "Ù…ØµØ·ÙÙ‰ ÙØ¤Ø§Ø¯ ÙØ§Ø¶Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ø§Ù…ÙŠØ±", "Ø¹Ù„ÙŠ Ø¬Ù…Ø§Ù„ Ø®Ù„Ù ÙØ¹ÙŠÙ„", "Ù…ØµØ·ÙÙ‰ Ù…Ø­Ù…Ø¯ Ù…Ø±Ø¯Ø§Ù† Ø­Ø³Ù†",
            "Ø¶Ø­Ù‰ Ø­ÙŠØ¯Ø± ÙƒÙ…Ø§Ù„ Ø¬ÙˆØ¯Ù‡", "Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø¬Ø¨Ø§Ø± Ø­Ø³ÙŠÙ†", "Ø¨Ù†ÙŠÙ† Ø¯ÙŠØ§Ø± Ø±Ø­ÙŠÙ… ØµÙØ±",
            "Ø²Ù‡Ø±Ø§Ø¡ Ù…Ø­Ù…Ø¯ Ø³Ø±ÙŠØ­ Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ø³Ù†", "Ø²Ù‡Ø±Ø§Ø¡ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ù‡Ø¯ÙŠ Ø®Ø¶ÙŠØ±", "Ù…Ù†ØªØ¸Ø± Ø­Ù…ÙŠØ¯ Ø¹Ø°Ø§Ø¨ Ø¶Ø§Ø­ÙŠ",
            "Ù†Ø¨Ø£ Ø¬Ø§Ø³Ù… Ø±Ø­Ù…Ù‡ Ø´Ø§ÙŠØ¹", "Ù…Ø¹ØµÙˆÙ…Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ø³ÙŠÙ† Ø¬Ø¨Ø§Ø± Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", "Ø¯Ø§Ù„ÙŠØ§ ÙƒØ±ÙŠÙ… Ù„ÙŠÙ„Ùˆ Ù…Ù†ØµÙˆØ±",
            "Ù…Ø¤Ù…Ù„ Ø³Ø¹Ø¯ÙˆÙ† Ø¬Ø¨Ø§Ø± Ù„ÙØªÙ‡", "Ø³Ø¨Ø£ Ù…Ø­Ù…Ø¯ ØµØ¨Ø±ÙŠ Ø³Ù„Ø·Ø§Ù†", "Ø±Ù‚ÙŠÙ‡ Ø§Ø«ÙŠØ± Ø§Ø­Ù…Ø¯ Ù…Ø·Ù„Ù‚", "ÙƒØ§Ø¸Ù… Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø³Ù…"
        ];

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDLSX6DY_79BD8ZEYBRYh_jtmP0mHslzkE",
            authDomain: "ai-attendance-husam.firebaseapp.com",
            databaseURL: "https://ai-attendance-husam-default-rtdb.firebaseio.com",
            projectId: "ai-attendance-husam",
            storageBucket: "ai-attendance-husam.firebasestorage.app",
            messagingSenderId: "305903941972",
            appId: "1:305903941972:web:d914431aab5a1cc6b5b0c1",
            measurementId: "G-EJEKCTT2M9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let studentsList = [];

        function generateStudentId(index) {
            return `2025-AI-${String(index + 1).padStart(3, '0')}`;
        }

        function generateQRCodeImage(text, size = 200) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
        }

        function generateAllQRCodes() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = '';

            const listToUse = studentsList.length > 0 ? studentsList : localStudents;

            listToUse.forEach((student, index) => {
                const studentId = generateStudentId(index);
                const qrData = JSON.stringify({
                    id: studentId,
                    name: student,
                    department: "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
                    university: "Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…ØµØ·ÙÙ‰"
                });

                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'glass-card'; // Wrapper for layout including button

                // Actual downloadable ID Card
                const card = document.createElement('div');
                card.id = `card-${index}`;
                card.className = 'id-card';
                card.style.position = 'relative'; // Ensure context for captures
                card.style.background = '#1e293b'; // Fixing bg for screenshot
                card.innerHTML = `
                    <div class="id-header">
                        <div style="color: white; font-weight: 900; font-size: 1.5rem;">AI DEPT</div>
                    </div>
                    <div class="id-body" style="color: white;">
                        <div style="width: 80px; height: 80px; background: rgba(99,102,241,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2.5rem;">
                            ğŸ‘¤
                        </div>
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem;">${student}</h3>
                        <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 1rem;">Ù‚Ø³Ù… Ø¹Ù„ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                        
                        <div class="qr-box" style="background: white; padding: 10px; border-radius: 12px; display: inline-block;">
                            <img src="${generateQRCodeImage(qrData, 200)}" alt="QR" style="width: 200px; height: 200px; display: block;" crossorigin="anonymous">
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <div class="badge" style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 100px; display: inline-block; font-family: monospace;">
                                ${studentId}
                            </div>
                        </div>
                    </div>
                `;

                // Add card to wrapper
                cardWrapper.appendChild(card);

                // Add download button below card
                const btnContainer = document.createElement('div');
                btnContainer.className = 'no-print';
                btnContainer.style.padding = '1rem';
                btnContainer.style.textAlign = 'center';
                btnContainer.innerHTML = `
                    <button class="btn btn-secondary" onclick="downloadCard(${index}, '${student}')" style="width: 100%; font-size: 0.9rem;">
                        â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                    </button>
                `;
                cardWrapper.appendChild(btnContainer);

                grid.appendChild(cardWrapper);
            });
        }

        async function downloadCard(index, studentName) {
            const cardElement = document.getElementById(`card-${index}`);

            // Visual feedback
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

            try {
                const canvas = await html2canvas(cardElement, {
                    scale: 3, // High quality
                    useCORS: true, // Allow fetching QR image
                    backgroundColor: '#1e293b' // Force dark background
                });

                const link = document.createElement('a');
                link.download = `ID_${studentName.replace(/\s+/g, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                btn.innerText = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                setTimeout(() => btn.innerText = originalText, 2000);
            } catch (err) {
                console.error(err);
                alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                btn.innerText = originalText;
            }
        }

        async function fetchStudents() {
            try {
                const snap = await db.ref('students_list').once('value');
                if (snap.exists() && Array.isArray(snap.val())) {
                    studentsList = snap.val();
                    console.log("Loaded students from Firebase");
                } else {
                    console.log("Using local student list");
                    studentsList = localStudents;
                }
            } catch (error) {
                console.error("Error loading students:", error);
                studentsList = localStudents;
            }
            generateAllQRCodes();
        }

        window.addEventListener('load', () => {
            fetchStudents();
        });
    </script>
</body>

</html>