<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep AI | Ù…Ø³Ø­ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚Øª</title>
    <link rel="stylesheet" href="style.css">

    <!-- Local Nimiq QR Scanner -->
    <script src="js/qr-scanner.umd.min.js"></script>
    <script>
        if (typeof QrScanner !== 'undefined') {
            QrScanner.WORKER_PATH = 'js/qr-scanner-worker.min.js';
        }
    </script>

    <!-- Go Backend -->
    <script src="js/api.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Ù…Ø³Ø­ Ø§Ù„Ø­Ø¶ÙˆØ± - Ø·Ø§Ù„Ø¨ Ù…ÙÙˆØ¶</h1>
            <div id="session-info" class="badge badge-warning">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr;">
            <!-- Session Info -->
            <div class="glass-card" id="session-card" style="padding: 1.5rem; display: none;">
                <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
                <div style="margin-top: 1rem;">
                    <p><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> <span id="session-subject">-</span></p>
                    <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> <span id="session-type">-</span></p>
                    <p><strong>ØªÙ†ØªÙ‡ÙŠ ÙÙŠ:</strong> <span id="session-expires">-</span></p>
                    <p><strong>Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†:</strong> <span id="scan-counter">0</span></p>
                </div>
            </div>

            <!-- Scanner -->
            <div class="glass-card" id="scanner-card" style="padding: 1.5rem; display: none;">
                <h3>Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</h3>
                <div class="camera-wrapper" style="margin-top: 1rem;">
                    <video id="qr-video"></video>
                    <div class="scan-overlay">
                        <div class="scan-frame">
                            <div class="scan-laser"></div>
                        </div>
                    </div>
                    <div class="status-pill">
                        <div id="cam-dot" class="status-dot"></div>
                        <span id="cam-status">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙˆÙ‚ÙØ©</span>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="startCamera()" style="flex:1;">âš¡ ØªØ´ØºÙŠÙ„</button>
                    <button class="btn btn-secondary" onclick="stopCamera()" style="flex:1;">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù</button>
                </div>
            </div>

            <!-- Recent Scans -->
            <div class="glass-card" id="list-card" style="padding: 1.5rem; display: none;">
                <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                <div id="recent-list" class="recent-scans" style="margin-top:1rem; min-height:200px;">
                    <div style="text-align:center; color:var(--text-muted); margin-top:3rem;">
                        ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="glass-card" id="error-card" style="padding: 2rem; text-align: center; display: none;">
                <h2 style="color: #ff4444;">âš ï¸ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·</h2>
                <p style="margin-top: 1rem; color: var(--text-muted);">
                    Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù… ÙŠØ¹Ø¯ ØµØ§Ù„Ø­Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯ÙƒØªÙˆØ±.
                </p>
            </div>
        </div>
    </div>

    <!-- Audios -->
    <audio id="beepOk" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="beepFail" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>

    <script>
        // Firebase Setup
        const firebaseConfig = {};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Get session token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionToken = urlParams.get('token');

        let sessionData = null;
        let qrScanner = null;
        let scannedIds = new Set();
        let scanCount = 0;
        let isScanned = false;

        // Validate session on load
        window.addEventListener('DOMContentLoaded', async () => {
            if (!sessionToken) {
                showError('Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­');
                return;
            }

            try {
                // Get session data from backend
                const response = await fetch(`/api/session/${sessionToken}`);
                if (!response.ok) {
                    showError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·');
                    return;
                }

                sessionData = await response.json();

                // Check expiration
                if (Date.now() > sessionData.expiresAt) {
                    showError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·');
                    return;
                }

                // Show session info
                showSession();
                startExpirationTimer();
            } catch (e) {
                console.error('Session validation error:', e);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©');
            }
        });

        function showSession() {
            document.getElementById('session-info').innerText = 'âœ… Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©';
            document.getElementById('session-info').className = 'badge badge-success';

            document.getElementById('session-subject').innerText = sessionData.subject;
            document.getElementById('session-type').innerText = sessionData.lectureType;

            const expiresDate = new Date(sessionData.expiresAt);
            document.getElementById('session-expires').innerText = expiresDate.toLocaleString('ar-EG');

            document.getElementById('session-card').style.display = 'block';
            document.getElementById('scanner-card').style.display = 'block';
            document.getElementById('list-card').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('session-info').innerText = 'âŒ ØºÙŠØ± ØµØ§Ù„Ø­';
            document.getElementById('session-info').className = 'badge badge-danger';
            document.getElementById('error-card').style.display = 'block';
        }

        function startExpirationTimer() {
            setInterval(() => {
                if (Date.now() > sessionData.expiresAt) {
                    showError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·');
                    if (qrScanner) qrScanner.stop();
                }
            }, 5000); // Check every 5 seconds
        }

        // Camera functions
        async function startCamera() {
            if (typeof QrScanner === 'undefined') {
                alert("Ø®Ø·Ø£: Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø§Ø³Ø­ ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©");
                return;
            }

            if (qrScanner) {
                qrScanner.start();
                updateUI(true);
                return;
            }

            const videoElem = document.getElementById('qr-video');
            qrScanner = new QrScanner(
                videoElem,
                result => processResult(result),
                {
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                    maxScansPerSecond: 5,
                    returnDetailedScanResult: true
                }
            );

            try {
                await qrScanner.start();
                updateUI(true);
            } catch (e) {
                console.error("Camera Error:", e);
                alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.");
            }
        }

        function stopCamera() {
            if (qrScanner) {
                qrScanner.stop();
                updateUI(false);
            }
        }

        function updateUI(active) {
            const statusText = document.getElementById('cam-status');
            const statusDot = document.getElementById('cam-dot');

            if (active) {
                statusText.innerText = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø´Ø·Ø©';
                statusDot.style.backgroundColor = '#00ff88';
            } else {
                statusText.innerText = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙˆÙ‚ÙØ©';
                statusDot.style.backgroundColor = '#ff4444';
            }
        }

        // Helper function to decode HTML entities
        function decodeHTMLEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        // Helper function to decode UTF-8 encoded QR data
        function decodeUTF8(text) {
            try {
                // Reverse the unescape(encodeURIComponent()) encoding used in QR generation
                return decodeURIComponent(escape(text));
            } catch (e) {
                // If decoding fails, return original text
                return text;
            }
        }

        async function processResult(result) {
            if (isScanned) return;
            if (Date.now() > sessionData.expiresAt) {
                showError('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·');
                stopCamera();
                return;
            }

            let rawText = result.data;

            // STEP 1: Decode UTF-8 (from QRious encoding workaround)
            rawText = decodeUTF8(rawText);

            // STEP 2: Decode HTML entities if present (for legacy QR codes)
            if (rawText.includes('&')) {
                rawText = decodeHTMLEntities(rawText);
            }

            let student = null;

            try {
                student = JSON.parse(rawText);

                // Decode HTML entities in student data (for legacy QR codes)
                if (student.name && student.name.includes('&')) {
                    student.name = decodeHTMLEntities(student.name);
                }
                if (student.department && student.department.includes('&')) {
                    student.department = decodeHTMLEntities(student.department);
                }
                if (student.university && student.university.includes('&')) {
                    student.university = decodeHTMLEntities(student.university);
                }
            } catch (e) {
                if (typeof rawText === 'string' && rawText.length > 2) {
                    student = {
                        id: "legacy_" + Math.random().toString(36).substr(2, 9),
                        name: decodeHTMLEntities(rawText.trim()),
                        type: 'legacy_plain'
                    };
                } else {
                    return;
                }
            }

            if (!student.id || !student.name) return;

            // Check duplicate - PREVENT MULTIPLE SCANS
            if (scannedIds.has(student.id)) {
                // Visual feedback for duplicate
                const frame = document.querySelector('.scan-frame');
                frame.style.borderColor = '#ff4444';
                setTimeout(() => frame.style.borderColor = 'rgba(255,255,255,0.5)', 500);

                document.getElementById('beepFail').play().catch(() => { });
                showToast(`âš ï¸ ${student.name} Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©`, 'warning');

                // Prevent re-scanning for 2 seconds
                isScanned = true;
                setTimeout(() => isScanned = false, 2000);
                return;
            }

            isScanned = true;
            confirmScan(student);
        }

        function confirmScan(student) {
            document.getElementById('beepOk').play().catch(() => { });
            const frame = document.querySelector('.scan-frame');
            frame.style.borderColor = '#00ff88';
            setTimeout(() => frame.style.borderColor = 'rgba(255,255,255,0.5)', 500);

            scannedIds.add(student.id);
            scanCount++;
            document.getElementById('scan-counter').innerText = scanCount;
            addToList(student.name);

            // Save to backend
            const record = {
                studentId: student.id,
                studentName: student.name,
                subject: sessionData.subject,
                lectureType: sessionData.lectureType,
                date: new Date().toLocaleDateString('en-CA'),
                time: new Date().toLocaleTimeString('ar-EG'),
                timestamp: Date.now(),
                engine: 'Delegate_v1',
                sessionToken: sessionToken
            };

            // Log with proper formatting
            console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±:", {
                Ø§Ù„Ø·Ø§Ù„Ø¨: student.name,
                Ø§Ù„Ø±Ù‚Ù…: student.id,
                Ø§Ù„Ù…Ø§Ø¯Ø©: sessionData.subject
            });

            db.ref('attendanceRecords').push(record)
                .then(() => {
                    showToast(`âœ… ${student.name}`, 'success');
                })
                .catch(e => {
                    console.error("âŒ Save Error:", e);
                    showToast(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`, "danger");
                });

            setTimeout(() => isScanned = false, 1500);
        }

        function addToList(name) {
            const list = document.getElementById('recent-list');
            const item = document.createElement('div');
            item.className = 'scan-item success';

            // Decode HTML entities and handle Unicode
            const tempDiv = document.createElement('textarea');
            tempDiv.innerHTML = name;
            let decodedName = tempDiv.value;

            // If still looks encoded, try textContent
            if (decodedName.includes('&') || decodedName.includes('#')) {
                const tempDiv2 = document.createElement('div');
                tempDiv2.innerHTML = name;
                decodedName = tempDiv2.textContent || tempDiv2.innerText || name;
            }

            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <strong>${decodedName}</strong>
                    <small>${new Date().toLocaleTimeString('ar-EG')}</small>
                </div>
            `;

            const emptyMsg = list.querySelector('[style*="text-align:center"]');
            if (emptyMsg) emptyMsg.remove();

            list.prepend(item);
        }

        function showToast(message, type) {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `badge badge-${type}`;
            toast.innerText = message;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.padding = '1rem 1.5rem';
            toast.style.fontSize = '1rem';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>

</html>